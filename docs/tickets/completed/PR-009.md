# PR-009: Bildbearbeitung vor Analyse (Crop, Helligkeit, Kontrast)

**Status:** üü¢ Erledigt
**Priorit√§t:** ‚ö° Mittel
**Typ:** ‚ú® Feature
**Erstellt:** 2026-02-18
**Erledigt:** 2026-02-19

## Beschreibung
Wenn ein User ein Foto macht oder hochl√§dt, muss er es **vor der Analyse** bearbeiten k√∂nnen. Ziel: Exakte Textbl√∂cke ausw√§hlen (z.B. aus B√ºchern mit Bildern) und die Bildqualit√§t f√ºr die OCR/Analyse optimieren.

## Umsetzung

### ImageEditor-Komponente
- [x] `src/components/image-editor.tsx` mit Crop, Helligkeit, Kontrast
- [x] react-image-crop Library integriert, touch-f√§hig
- [x] shadcn/ui Slider f√ºr Helligkeit/Kontrast (50‚Äì150%)
- [x] CSS-Filter Live-Vorschau (GPU-beschleunigt)
- [x] Canvas-Verarbeitung bei Best√§tigung (Crop + Filter ‚Üí base64 JPEG)
- [x] Editor √∂ffnet sich inline im Kamera-Tab nach Foto/Upload
- [x] Kamera-Stream wird gestoppt wenn Editor offen
- [x] Zur√ºcksetzen-Button, Abbrechen-Button
- [x] Fehleranzeige im Editor (bleibt offen bei Fehler, Retry m√∂glich)
- [x] Loading-State mit Spinner + "Text wird erkannt..."

### OCR-Submission (Fix)
- [x] **Eigentliche Ursache:** Hardcoded `media_type: "image/jpeg"` in `actions.ts` stimmte nicht mit dem tats√§chlichen Bildformat √ºberein (Anthropic API: "Image does not match the provided media type image/jpeg")
- [x] **Fix 1 (Hauptfix):** `detectMediaType()` in `actions.ts` ‚Äî erkennt Format aus base64 Magic Bytes (`/9j/` = JPEG, `iVBOR` = PNG, etc.)
- [x] **Fix 2:** `image-editor.tsx` ‚Äî Pr√ºft `image.complete` vor Canvas-Zugriff, verifiziert JPEG-Output nach `toDataURL()`, lokale Fehlermeldung bei Konvertierungsproblemen
- [x] **Fix 3:** `next.config.ts` ‚Äî `experimental.serverActions.bodySizeLimit: '10mb'` (pr√§ventiv)
- [x] **Fix 4:** Bild-Downscaling auf max 2048px + JPEG-Qualit√§t 0.85 vor Senden
- [x] **Diagnose:** Catch-Block in `runOCR()` gibt echte `error.message` zur√ºck statt generischem String

### Debugging-Chronik
1. Generischer Catch-Block ("Failed to connect to Claude API") hat echten Fehler verschleiert
2. Erst nach Einbau der echten Fehlermeldung wurde die Ursache sichtbar: media_type Mismatch
3. Lektion: Immer zuerst den echten Fehler sichtbar machen, bevor man Vermutungen fixt

## Betroffene Dateien
- `src/components/image-editor.tsx` ‚Äî ImageEditor-Komponente (NEU)
- `src/components/ui/slider.tsx` ‚Äî shadcn/ui Slider (NEU)
- `src/app/page.tsx` ‚Äî Integration: capturedImage State, Editor-Rendering, OCR-Submission
- `src/app/actions.ts` ‚Äî `detectMediaType()`, echte Fehlermeldung im Catch-Block
- `src/app/globals.css` ‚Äî react-image-crop CSS-Overrides
- `next.config.ts` ‚Äî Body-Size-Limit f√ºr Server Actions
- `package.json` ‚Äî react-image-crop Dependency

## Nicht in v1 (optional f√ºr sp√§ter)
- Rotation (90¬∞-Schritte)
- Pinch-to-Zoom
- Undo/Redo (Reset-Button reicht)
