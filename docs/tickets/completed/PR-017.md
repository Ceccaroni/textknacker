# PR-017: Bugfix ‚Äì HEIC/JPEG Media-Type Mismatch bei Bild-Upload (iPhone)

**Status:** üü¢ Erledigt
**Priorit√§t:** üî• Hoch
**Typ:** üêõ Bug
**Erstellt:** 2026-02-19
**Erledigt:** 2026-02-19

## Beschreibung
iPhone-Fotos (HEIC-Format) f√ºhrten zu einem API-Fehler, weil der media_type hardcoded auf "image/jpeg" gesetzt war, das Bild aber nicht immer als JPEG aus dem Canvas kam.

## Ursache
1. `image-editor.tsx` exportierte Bilder via `canvas.toDataURL('image/jpeg')`, aber auf manchen Browsern f√§llt Canvas bei HEIC-Input still auf PNG zur√ºck
2. `actions.ts runOCR()` hatte `media_type: "image/jpeg"` hardcoded
3. Claude API erhielt ein PNG mit dem Label "image/jpeg" ‚Üí `400 invalid_request_error`
4. Der Catch-Block gab nur "Failed to connect to Claude API" aus ‚Äì der echte Fehler war unsichtbar

## Was stundenlang schiefging
- Claude Code hat den Fehler als Bildgr√∂ssenproblem fehldiagnostiziert (Body-Size-Limit, Downscaling)
- Der generische Catch-Block hat den echten API-Fehler verschluckt
- 3+ Stunden Arbeit am falschen Problem

## Fix
1. Error-Handling: Echte Fehlermeldung aus dem Catch-Block zur√ºckgeben
2. Image-Editor: Nach `toDataURL('image/jpeg')` pr√ºfen ob Output wirklich JPEG ist
3. Wenn PNG-Fallback: Bild als PNG mit `media_type: "image/png"` an API senden
4. `actions.ts`: media_type nicht mehr hardcoded, sondern vom Image-Editor √ºbernommen

## Betroffene Dateien
- [x] src/components/image-editor.tsx
- [x] src/app/actions.ts
- [x] next.config.ts (Body-Size-Limit war unn√∂tig, aber nicht sch√§dlich)

## Lessons Learned
- Catch-Blocks M√úSSEN den echten Fehler weiterreichen
- Vor dem Fixen: Echten Fehler diagnostizieren
- Nicht blind Dinge √§ndern die mit dem Problem nichts zu tun haben
- iPhone-HEIC ist ein bekannter Stolperstein ‚Üí immer mitdenken
