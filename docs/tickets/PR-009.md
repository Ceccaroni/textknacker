# PR-009: Bildbearbeitung vor Analyse (Crop, Helligkeit, Kontrast)

**Status:** ðŸŸ¡ In Arbeit
**PrioritÃ¤t:** âš¡ Mittel
**Typ:** âœ¨ Feature
**Erstellt:** 2026-02-18
**Erledigt:** â€”

## Beschreibung
Wenn ein User ein Foto macht oder hochlÃ¤dt, muss er es **vor der Analyse** bearbeiten kÃ¶nnen. Ziel: Exakte TextblÃ¶cke auswÃ¤hlen (z.B. aus BÃ¼chern mit Bildern) und die BildqualitÃ¤t fÃ¼r die OCR/Analyse optimieren.

## Stand der Umsetzung

### Funktioniert
- [x] ImageEditor-Komponente (`src/components/image-editor.tsx`) mit Crop, Helligkeit, Kontrast
- [x] react-image-crop Library integriert, touch-fÃ¤hig
- [x] shadcn/ui Slider fÃ¼r Helligkeit/Kontrast (50â€“150%)
- [x] CSS-Filter Live-Vorschau (GPU-beschleunigt)
- [x] Canvas-Verarbeitung bei BestÃ¤tigung (Crop + Filter â†’ base64 JPEG)
- [x] Editor Ã¶ffnet sich inline im Kamera-Tab nach Foto/Upload
- [x] Kamera-Stream wird gestoppt wenn Editor offen
- [x] ZurÃ¼cksetzen-Button, Abbrechen-Button
- [x] Fehleranzeige im Editor (bleibt offen bei Fehler, Retry mÃ¶glich)
- [x] Loading-State mit Spinner + "Text wird erkannt..."

### Blockiert: OCR-Ãœbermittlung nach "Ãœbernehmen"
- [ ] **Das bearbeitete Bild kommt nicht erfolgreich bei der Claude API an**
- Fehler: "Server error: Failed to connect to Claude API."
- Textvereinfachung (Text eingeben â†’ Vereinfachen) funktioniert â€” API-Key ist OK
- Getestete AnsÃ¤tze, die NICHT funktioniert haben:
  1. `ocrFormAction(fd)` â€” programmatischer Dispatch von useActionState â†’ reagiert nicht
  2. `isOcrPending` von useActionState â†’ triggert nicht bei programmatischem Aufruf
  3. `await runOCR(ocrInitialState, fd)` â€” direkter Server-Action-Aufruf â†’ schlÃ¤gt fehl (~1s, kein echter API-Call)
  4. Hidden Form mit `requestSubmit()` + `ocrFormAction` als action â†’ API-Fehler

### Vermutete Ursache
- **Next.js Server Action Body-Size-Limit** (Standard: 1 MB) â€” Kamera-Bilder vom iPhone sind 2â€“5 MB base64
- Oder: FormData-Serialisierung Ã¼ber Server Actions funktioniert anders als Ã¼ber native Form-Submission
- Der originale Kamera-Capture-Flow (direkt im `<form action={...}>`) hat das Bild ebenfalls als base64 Ã¼bermittelt â€” dort hat es funktioniert. Der Unterschied: dort war die Funktion `captureAndSubmit` die Form-Action selbst und rief `ocrFormAction` innerhalb auf.

### NÃ¤chste Schritte fÃ¼r die LÃ¶sung
1. **Body-Size-Limit prÃ¼fen**: `serverActions.bodySizeLimit` in `next.config.js`/`next.config.ts` erhÃ¶hen (z.B. auf `'5mb'`)
2. **Alternative**: `captureAndSubmit`-Pattern wiederherstellen â€” den Editor-Confirm als Form-Action einer sichtbaren Form nutzen (statt Hidden Form)
3. **Debug**: Server-Logs auf Firebase prÃ¼fen (Console â†’ Cloud Functions â†’ Logs) um den tatsÃ¤chlichen Fehler zu sehen

## Betroffene Dateien
- `src/components/image-editor.tsx` â€” ImageEditor-Komponente (NEU, funktioniert)
- `src/components/ui/slider.tsx` â€” shadcn/ui Slider (NEU, funktioniert)
- `src/app/page.tsx` â€” Integration: capturedImage State, Editor-Rendering, OCR-Submission (ðŸ”´ OCR-Flow noch defekt)
- `src/app/globals.css` â€” react-image-crop CSS-Overrides
- `package.json` â€” react-image-crop Dependency

## Nicht in v1 (optional fÃ¼r spÃ¤ter)
- Rotation (90Â°-Schritte)
- Pinch-to-Zoom
- Undo/Redo (Reset-Button reicht)
